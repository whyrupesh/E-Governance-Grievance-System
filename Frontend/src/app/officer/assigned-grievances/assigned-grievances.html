<div class="officer-container animate-fade-in">

  <div class="page-header">
    <h2 class="page-title gradient-text">Assigned Grievances</h2>
    <p class="page-subtitle">Manage and resolve citizen complaints</p>
  </div>

  <div class="dashboard-grid" [class.has-selection]="selected">

    <!-- Left Panel: List -->
    <div class="list-column">

      <!-- Filters -->
      <div class="filters-container glass-panel">
        <!-- Status Filter -->
        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>Status</mat-label>
          <mat-select [ngModel]="filterStatus()" (ngModelChange)="filterStatus.set($event); onFilterChange()">
            <mat-option value="All">All Statuses</mat-option>
            @for (status of statuses; track status) {
            <mat-option [value]="status">{{ status }}</mat-option>
            }
          </mat-select>
        </mat-form-field>

        <!-- Category Filter -->
        <!-- <mat-form-field appearance="outline" class="filter-field">
          <mat-label>Category</mat-label>
          <mat-select [ngModel]="filterCategory()" (ngModelChange)="filterCategory.set($event); onFilterChange()">
            <mat-option value="All">All Categories</mat-option>
            @for (cat of categories(); track cat.id) {
            <mat-option [value]="cat.name">{{ cat.name }}</mat-option>
            }
          </mat-select>
        </mat-form-field> -->

        <!-- Sort By Date -->
        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>Sort By Date</mat-label>
          <mat-select [ngModel]="sortOrder()" (ngModelChange)="sortOrder.set($event)">
            <mat-option value="newest">Newest First</mat-option>
            <mat-option value="oldest">Oldest First</mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <div class="list-panel glass-panel">
        <table class="premium-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Category</th>
              <th>Status</th>
              <th>Escalated</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            @if(grievances().length === 0) {
            <tr class="empty-row">
              <td colspan="5">
                <div class="empty-state">
                  <mat-icon>assignment_turned_in</mat-icon>
                  <p>No active grievances assigned.</p>
                </div>
              </td>
            </tr>
            }
            @else if (filteredGrievances().length === 0) {
            <tr class="empty-row">
              <td colspan="5">
                <div class="empty-state">
                  <mat-icon>search_off</mat-icon>
                  <p>No matches found.</p>
                  <button mat-stroked-button color="primary" class="reset-btn" (click)="resetFilters()">
                    Reset Filters
                  </button>
                </div>
              </td>
            </tr>
            }
            @else {
            @for (g of paginatedGrievances(); track g.id) {
            <tr [class.selected-row]="selected?.id === g.id">
              <td class="id-cell">#{{ g.grievanceNumber }}</td>
              <td>{{ g.category }}</td>
              <td>
                <span class="status-chip {{ g.status.toLowerCase() }}">
                  {{ g.status }}
                </span>
              </td>
              <td class="escalated-cell">
                <div class="escalated-info" [style.color]="g.isEscalated ? 'red' : 'green'">
                  <mat-icon class="escalated-icon">{{ g.isEscalated ? 'warning' : 'check_circle' }}</mat-icon>
                  <span>{{ g.isEscalated ? 'Escalated' : 'Normal' }}</span>
                </div>
              </td>
              <button mat-stroked-button color="primary" class="action-btn" (click)="select(g)">
                Update
              </button>
            </tr>
            }
            }
          </tbody>
        </table>

        <!-- Paginator -->
        <mat-paginator [length]="filteredGrievances().length" [pageSize]="pageSize()"
          [pageSizeOptions]="[5, 10, 25, 50]" (page)="handlePageEvent($event)" showFirstLastButtons
          aria-label="Select page of grievances">
        </mat-paginator>
      </div>
    </div>

    <!-- Right Panel: Usage -->
    @if (selected) {
    <div class="detail-panel glass-panel animate-slide-in">
      <div class="panel-header">
        <h3>Update Status</h3>
        <button mat-icon-button (click)="selected = undefined">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="grievance-summary">
        <div class="summary-item">
          <label>Description</label>
          <p>{{ selected.description }}</p>
        </div>
      </div>

      <mat-divider></mat-divider>

      <form [formGroup]="form" class="update-form">
        <mat-form-field appearance="outline" class="custom-field">
          <mat-label>New Status</mat-label>
          <mat-select formControlName="status">
            <mat-option [value]="GrievanceStatus.InReview">In Review</mat-option>
            <mat-option [value]="GrievanceStatus.Resolved">Resolved</mat-option>
          </mat-select>
        </mat-form-field>

        @if(form.value.status === GrievanceStatus.Resolved) {
        <mat-form-field appearance="outline" class="custom-field">
          <mat-label>Officer Remarks</mat-label>
          <textarea matInput rows="5" formControlName="resolutionRemarks"
            placeholder="Enter resolution details..."></textarea>
        </mat-form-field>
        }
        <div class="form-actions">
          <button mat-flat-button color="primary" class="full-width-btn" (click)="submit()">
            Update Status
          </button>
        </div>
      </form>
    </div>
    }

  </div>
</div>